import pytest
import compas
import numpy as np
import gkr_mult_drt_robot.solver.multiple_directions_calculator
import gkr_mult_drt_robot.solver.seperating_axis
import numpy as np

def test_case0():
    # 8 points defining the cube corners
    pts0 = np.array([[27.6684498196, 8.34619851663, 0.694061328389],
                     [27.6286773282, 8.34512114360, 0.668114494376],
                     [27.6177429316, 8.34581589087, 0.684846388992],
                     [27.6575154230, 8.34689326390, 0.710793223005],
                     [27.5701924751, 7.92003228565, 0.862370085803],
                     [27.5304199837, 7.91895491262, 0.836423251789],
                     [27.5194855871, 7.91964965988, 0.853155146406],
                     [27.5592580785, 7.92072703291, 0.879101980419],
                     [27.3197423599, 8.03459300392, 1.24151462501],
                     [27.2799698685, 8.03351563089, 1.21556779100],
                     [27.2690354719, 8.03421037816, 1.23229968561],
                     [27.3088079633, 8.03528775118, 1.25824651962],
                     [27.7425809242, 8.11788788104, 0.577909777662],
                     [27.7425786134, 8.11788781844, 0.577909777662],
                     [27.7423619857, 8.12588488493, 0.577909777662],
                     [27.7423642965, 8.12588494753, 0.577909777662],
                     [27.7351049515, 8.39387220012, 0.577909777662],
                     [27.7351026406, 8.39387213753, 0.577909777662],
                     [27.7348860129, 8.40186920402, 0.577909777662],
                     [27.7348883238, 8.40186926661, 0.577909777662],
                     [27.7500568970, 7.84190356196, 0.577909777662],
                     [27.7500545861, 7.84190349936, 0.577909777662],
                     [27.7498379584, 7.84990056585, 0.577909777662],
                     [27.7498402692, 7.84990062845, 0.577909777662],
                     [27.7440362543, 7.62013130876, 0.559909777662],
                     [27.7450076468, 7.62207567944, 0.559909777662],
                     [27.7560781496, 7.61962194657, 0.570909777662],
                     [27.7553674726, 7.61819943256, 0.570909777662],
                     [27.7275954856, 8.62685257410, 0.570909777662],
                     [27.7288484937, 8.62483669033, 0.570909777662],
                     [27.7179332095, 8.62156034729, 0.559909777662],
                     [27.7163350358, 8.62413154578, 0.559909777662],
                     [27.7560781496, 7.61962194657, 0.579311225954],
                     [27.7288484937, 8.62483669033, 0.581191501785],
                     [27.7289081544, 8.62263424770, 0.589909777662],
                     [27.7560201054, 7.62176471453, 0.589909777662],
                     [27.6537295003, 8.59334763233, 0.559909777662],
                     [27.0558545379, 8.05908566283, 1.49854360963],
                     [27.0987904372, 8.05956010392, 1.57916312422],
                     [27.6794541487, 7.64369200722, 0.559909777662]])

    pts1 = np.array([[26.2604436180, 8.17515820696, 2.33526979353],
                     [26.2604436180, 8.17515820696, 2.32786001587],
                     [26.2404436180, 8.17515820696, 2.32786001587],
                     [26.2404436180, 8.17515820696, 2.33526979353],
                     [26.2253753685, 8.23589819679, 2.33526979353],
                     [26.2253753685, 8.23589819679, 2.32786001587],
                     [26.2053753685, 8.23589819679, 2.32786001587],
                     [26.2053753685, 8.23589819679, 2.33526979353],
                     [26.1716476932, 8.28098106931, 2.33526979353],
                     [26.1716476932, 8.28098106931, 2.32786001587],
                     [26.1619274850, 8.27098498425, 2.32786001587],
                     [26.1561393386, 8.27263493074, 2.33305281156],
                     [26.1561393386, 8.27263493074, 2.33526979353],
                     [26.6040261824, 8.48634695648, 1.84701212987],
                     [26.5720051462, 8.46785949681, 1.81719406356],
                     [26.5572328386, 8.47496405456, 1.82865286741],
                     [26.5892538747, 8.49345151423, 1.85847093372],
                     [26.9259445303, 8.81860139207, 1.29530970344],
                     [26.8939234941, 8.80011393240, 1.26549163713],
                     [26.8791511865, 8.80721849014, 1.27695044098],
                     [26.9111722226, 8.82570594981, 1.30676850729],
                     [26.9413604541, 8.41330692877, 1.53004092700],
                     [26.9093394180, 8.39481946910, 1.50022286069],
                     [26.8945671103, 8.40192402684, 1.51168166453],
                     [26.9265881465, 8.42041148651, 1.54149973084],
                     [26.1550762802, 8.28285155106, 2.32786001587],
                     [26.1596539541, 8.29078030420, 2.32786001587],
                     [26.1622838257, 8.29096081558, 2.33526979353],
                     [26.1755053051, 8.35909575893, 2.25864961699],
                     [27.1667199461, 9.38213611455, 0.559909777662],
                     [27.1910884670, 9.33992883999, 0.559909777662],
                     [27.0451333904, 8.05987363856, 1.51029339408],
                     [26.2502337976, 8.10965854700, 2.33305338997],
                     [26.1862815570, 8.33252604960, 2.33526979353],
                     [26.2003849638, 8.34809819661, 2.35026979353],
                     [26.1988511165, 8.35075488108, 2.34126979353],
                     [26.2013365863, 8.35505983524, 2.34126979353],
                     [26.2060263513, 8.35432709830, 2.35626979353],
                     [26.2034879126, 8.35472370832, 2.348150713],
                     [26.2046159859, 8.35276984071, 2.35476979353],
                     [26.2501875580, 8.10973863638, 2.33526979353],
                     [26.3158868612, 8.10804451905, 2.33526979353],
                     [27.2307539018, 9.40535165933, 0.559909777662],
                     [27.2234206786, 9.41714960835, 0.559909777662],
                     [27.2339753155, 9.42100617356, 0.570909777662],
                     [27.2408412569, 9.40996000408, 0.570909777662],
                     [27.2361430783, 9.41751860001, 0.5908597089],
                     [27.2472524117, 9.39964551133, 0.590011083816],
                     [27.0946408330, 8.06121145562, 1.58373838307],
                     [26.2027794372, 8.35595081585, 2.34126979353],
                     [26.3482689789, 8.10795705060, 2.35626979353],
                     [26.3390169811, 8.10798204066, 2.35026979353],
                     [26.3459560171, 8.10796329715, 2.35476979353],
                     [26.3392047445, 8.10765682711, 2.34126979353],
                     [26.3462376621, 8.10747547682, 2.34126979353]])

    result = gkr_mult_drt_robot.solver.seperating_axis.compute_seprating_plane(pts0, pts1)
    print(result)

def test_case1():
    points = [[[27.6684498196, 8.34619851663, 0.694061328389],
[27.6286773282, 8.34512114360, 0.668114494376],
[27.6177429316, 8.34581589087, 0.684846388992],
[27.6575154230, 8.34689326390, 0.710793223005],
[27.5701924751, 7.92003228565, 0.862370085803],
[27.5304199837, 7.91895491262, 0.836423251789],
[27.5194855871, 7.91964965988, 0.853155146406],
[27.5592580785, 7.92072703291, 0.879101980419],
[27.3197423599, 8.03459300392, 1.24151462501],
[27.2799698685, 8.03351563089, 1.21556779100],
[27.2690354719, 8.03421037816, 1.23229968561],
[27.3088079633, 8.03528775118, 1.25824651962],
[27.7425809242, 8.11788788104, 0.577909777662],
[27.7425786134, 8.11788781844, 0.577909777662],
[27.7423619857, 8.12588488493, 0.577909777662],
[27.7423642965, 8.12588494753, 0.577909777662],
[27.7351049515, 8.39387220012, 0.577909777662],
[27.7351026406, 8.39387213753, 0.577909777662],
[27.7348860129, 8.40186920402, 0.577909777662],
[27.7348883238, 8.40186926661, 0.577909777662],
[27.7500568970, 7.84190356196, 0.577909777662],
[27.7500545861, 7.84190349936, 0.577909777662],
[27.7498379584, 7.84990056585, 0.577909777662],
[27.7498402692, 7.84990062845, 0.577909777662],
[27.7440362543, 7.62013130876, 0.559909777662],
[27.7450076468, 7.62207567944, 0.559909777662],
[27.7560781496, 7.61962194657, 0.570909777662],
[27.7553674726, 7.61819943256, 0.570909777662],
[27.7275954856, 8.62685257410, 0.570909777662],
[27.7288484937, 8.62483669033, 0.570909777662],
[27.7179332095, 8.62156034729, 0.559909777662],
[27.7163350358, 8.62413154578, 0.559909777662],
[27.7560781496, 7.61962194657, 0.579311225954],
[27.7288484937, 8.62483669033, 0.581191501785],
[27.7289081544, 8.62263424770, 0.589909777662],
[27.7560201054, 7.62176471453, 0.589909777662],
[27.6537295003, 8.59334763233, 0.559909777662],
[27.0558545379, 8.05908566283, 1.49854360963],
[27.0987904372, 8.05956010392, 1.57916312422],
[27.6794541487, 7.64369200722, 0.559909777662],
],
[[26.2604436180, 8.17515820696, 2.33526979353],
[26.2604436180, 8.17515820696, 2.32786001587],
[26.2404436180, 8.17515820696, 2.32786001587],
[26.2404436180, 8.17515820696, 2.33526979353],
[26.2253753685, 8.23589819679, 2.33526979353],
[26.2253753685, 8.23589819679, 2.32786001587],
[26.2053753685, 8.23589819679, 2.32786001587],
[26.2053753685, 8.23589819679, 2.33526979353],
[26.1716476932, 8.28098106931, 2.33526979353],
[26.1716476932, 8.28098106931, 2.32786001587],
[26.1619274850, 8.27098498425, 2.32786001587],
[26.1561393386, 8.27263493074, 2.33305281156],
[26.1561393386, 8.27263493074, 2.33526979353],
[26.6040261824, 8.48634695648, 1.84701212987],
[26.5720051462, 8.46785949681, 1.81719406356],
[26.5572328386, 8.47496405456, 1.82865286741],
[26.5892538747, 8.49345151423, 1.85847093372],
[26.9259445303, 8.81860139207, 1.29530970344],
[26.8939234941, 8.80011393240, 1.26549163713],
[26.8791511865, 8.80721849014, 1.27695044098],
[26.9111722226, 8.82570594981, 1.30676850729],
[26.9413604541, 8.41330692877, 1.53004092700],
[26.9093394180, 8.39481946910, 1.50022286069],
[26.8945671103, 8.40192402684, 1.51168166453],
[26.9265881465, 8.42041148651, 1.54149973084],
[26.1550762802, 8.28285155106, 2.32786001587],
[26.1596539541, 8.29078030420, 2.32786001587],
[26.1622838257, 8.29096081558, 2.33526979353],
[26.1755053051, 8.35909575893, 2.25864961699],
[27.1667199461, 9.38213611455, 0.559909777662],
[27.1910884670, 9.33992883999, 0.559909777662],
[27.0451333904, 8.05987363856, 1.51029339408],
[26.2502337976, 8.10965854700, 2.33305338997],
[26.1862815570, 8.33252604960, 2.33526979353],
[26.2003849638, 8.34809819661, 2.35026979353],
[26.1988511165, 8.35075488108, 2.34126979353],
[26.2013365863, 8.35505983524, 2.34126979353],
[26.2060263513, 8.35432709830, 2.35626979353],
[26.2034879126, 8.35472370832, 2.348150713],
[26.2046159859, 8.35276984071, 2.35476979353],
[26.2501875580, 8.10973863638, 2.33526979353],
[26.3158868612, 8.10804451905, 2.33526979353],
[27.2307539018, 9.40535165933, 0.559909777662],
[27.2234206786, 9.41714960835, 0.559909777662],
[27.2339753155, 9.42100617356, 0.570909777662],
[27.2408412569, 9.40996000408, 0.570909777662],
[27.2361430783, 9.41751860001, 0.5908597089],
[27.2472524117, 9.39964551133, 0.590011083816],
[27.0946408330, 8.06121145562, 1.58373838307],
[26.2027794372, 8.35595081585, 2.34126979353],
[26.3482689789, 8.10795705060, 2.35626979353],
[26.3390169811, 8.10798204066, 2.35026979353],
[26.3459560171, 8.10796329715, 2.35476979353],
[26.3392047445, 8.10765682711, 2.34126979353],
[26.3462376621, 8.10747547682, 2.34126979353],
],
[[27.5067726112, 7.51263290879, 0.811098333592],
[27.4734639967, 7.52927363454, 0.781604733453],
[27.4592053728, 7.52238197226, 0.793819340842],
[27.4925139872, 7.50574124651, 0.823312940981],
[27.2656077729, 7.67851663052, 1.17705203507],
[27.2322991584, 7.69515735627, 1.14755843493],
[27.2180405345, 7.68826569399, 1.15977304232],
[27.2513491489, 7.67162496824, 1.18926664246],
[27.3228464775, 7.08301839686, 0.77642055303],
[27.2895378630, 7.09965912261, 0.746926952891],
[27.2752792390, 7.09276746032, 0.759141560281],
[27.3085878535, 7.07612673457, 0.78863516042],
[27.3010547051, 6.70883231463, 0.577909777662],
[27.3010526372, 6.70883334776, 0.577909777662],
[27.2974772630, 6.70167676339, 0.577909777662],
[27.2974793310, 6.70167573025, 0.577909777662],
[27.5395340386, 7.18618025576, 0.577909777662],
[27.5395319706, 7.18618128889, 0.577909777662],
[27.5359565965, 7.17902470452, 0.577909777662],
[27.5359586645, 7.17902367138, 0.577909777662],
[27.4202943719, 6.94750628519, 0.577909777662],
[27.4202923039, 6.94750731833, 0.577909777662],
[27.4167169298, 6.94035073395, 0.577909777662],
[27.4167189977, 6.94034970082, 0.577909777662],
[27.6587737053, 7.42485422632, 0.577909777662],
[27.6587716374, 7.42485525946, 0.577909777662],
[27.6551962633, 7.41769867508, 0.577909777662],
[27.6551983312, 7.41769764194, 0.577909777662],
[27.0527317588, 8.05666999149, 1.50198189810],
[27.0466717479, 8.05253542186, 1.50649298952],
[27.0853680110, 8.05703062162, 1.56326205884],
[27.7535744135, 7.6146103875, 0.570909777662],
[27.2328374550, 6.57228646217, 0.570909777662],
[27.2225145540, 6.57623661892, 0.559909777662],
[27.7422431952, 7.61654226370, 0.559909777662],
[27.7551816200, 7.61782742404, 0.589909777662],
[27.2392037880, 6.58502951996, 0.589909777662],
[27.0978449562, 8.05569408556, 1.57932417252],
[27.6786156633, 7.63975471672, 0.559909777662],
[27.1819112367, 6.64553508377, 0.559909777662],
],
[[26.2604436180, 8.03701627107, 2.33526979353],
[26.2604436180, 8.03701627107, 2.32786001587],
[26.2404436180, 8.03701627107, 2.32786001587],
[26.2404436180, 8.03701627107, 2.33526979353],
[26.2253753685, 7.97627628124, 2.33526979353],
[26.2253753685, 7.97627628124, 2.32786001587],
[26.2053753685, 7.97627628124, 2.32786001587],
[26.2053753685, 7.97627628124, 2.33526979353],
[26.1716476932, 7.93119340872, 2.33526979353],
[26.1716476932, 7.93119340872, 2.32786001587],
[26.1588905992, 7.92158099837, 2.32786001587],
[26.1618185353, 7.92119486818, 2.33526979353],
[26.9087173623, 7.26982097112, 1.31519149486],
[26.8776357867, 7.28776656420, 1.28407652501],
[26.8625119322, 7.28122816967, 1.29541312156],
[26.8935935078, 7.26328257659, 1.32652809141],
[26.9450279585, 7.68931994483, 1.52086636368],
[26.9139463829, 7.70726553791, 1.48975139383],
[26.8988225284, 7.70072714338, 1.50108799038],
[26.9299041040, 7.68278155030, 1.53220296023],
[26.6048564179, 7.65598585037, 1.84144733807],
[26.5737748423, 7.67393144345, 1.81033236822],
[26.5586509878, 7.66739304892, 1.82166896477],
[26.5897325634, 7.64944745584, 1.85278393462],
[26.1539500306, 7.93013866461, 2.32786001587],
[26.1602783272, 7.94109920687, 2.32786001587],
[26.1561393386, 7.93953954730, 2.33526979353],
[26.1561393386, 7.93953954730, 2.33109502699],
[26.2521542949, 8.10584232998, 2.33109843192],
[27.0432247140, 8.05629724550, 1.51230185046],
[27.1792940593, 6.64066272894, 0.559909777662],
[27.1567029544, 6.60153517642, 0.559909777662],
[26.1760921079, 7.84775479150, 2.25822671323],
[26.2522387666, 8.10598863925, 2.33526979353],
[26.2014610186, 7.85632323158, 2.34126979353],
[26.1986866295, 7.86112881125, 2.34126979353],
[26.2003294626, 7.86397417807, 2.35026979353],
[26.1860447434, 7.87923212722, 2.33526979353],
[26.3160178981, 8.10434403532, 2.33526979353],
[27.2145215547, 6.56023757316, 0.559909777662],
[27.2248857304, 6.55637003320, 0.570909777662],
[27.2269313844, 6.56046468037, 0.588196976387],
[26.2060433831, 7.85787094152, 2.35626979353],
[26.2031744213, 7.85690193945, 2.34687847890],
[26.2024375685, 7.85562571950, 2.34126979353],
[26.3390771018, 8.10428338558, 2.35026979353],
[26.2046148783, 7.85939679332, 2.35476979353],
[26.3483007185, 8.10425912735, 2.35626979353],
[26.3459948629, 8.10426519066, 2.35476979353],
[26.3457214728, 8.10379168242, 2.34126979353],
[26.3388948417, 8.10396771342, 2.34126979353],
[27.2303190471, 6.56724553558, 0.570909777662],
[27.2366161348, 6.57984998985, 0.589703118707],
[27.2199961462, 6.57119569233, 0.559909777662],
[27.0945840901, 8.05751907515, 1.58382999721],
],]

    test_graph = [[0, 1, 2.72552053317e-16, -5.24649979352e-17, -1.0],
[0, 2, 2.72552053317e-16, -5.24649979352e-17, -1.0],
[0, 7, 0.519615242271, 0.3, -0.8],
[0, 7, 0.866025403784, 0.5, 6.12323399574e-17],
[0, 7, 2.72552053317e-16, -5.24649979352e-17, -1.0],
[0, 9, 0.519615242271, -0.3, -0.8],
[0, 9, 2.72552053317e-16, -5.24649979352e-17, -1.0],
[0, 9, 0.866025403784, -0.5, -6.12323399574e-17],
[2, 5, 3.43829769663e-11, -1.0, -1.22464679915e-16],
[2, 5, 3.43829769663e-11, -1.0, -1.22464679915e-16],
[2, 5, 3.43829769663e-11, -1.0, -1.22464679915e-16],
[2, 5, 3.43829769663e-11, -1.0, -1.22464679915e-16],
[2, 5, -3.43829769663e-11, 1.0, 1.22464679915e-16],
[2, 5, -3.43829769663e-11, 1.0, 1.22464679915e-16],
[2, 5, -3.43829769663e-11, 1.0, 1.22464679915e-16],
[2, 5, -3.43829769663e-11, 1.0, 1.22464679915e-16],
[2, 5, 3.80566689273e-11, -1.0, 0.0],
[2, 5, 3.80566689273e-11, -1.0, 0.0],
[2, 5, 3.80566689273e-11, -1.0, 0.0],
[2, 5, 3.80566689273e-11, -1.0, 0.0],
[2, 5, -3.80566689273e-11, 1.0, 0.0],
[2, 5, -3.80566689273e-11, 1.0, 0.0],
[2, 5, -3.80566689273e-11, 1.0, 0.0],
[2, 5, -3.80566689273e-11, 1.0, 0.0],
[2, 7, 0.674127076955, 0.38920967726, 0.62774876443],
[3, 4, -1.0, 9.62074864219e-12, 0.0],
[3, 4, -1.0, 9.62074864219e-12, 0.0],
[3, 4, -1.0, -3.43829769663e-11, -4.2106817679e-27],
[3, 4, -1.0, -3.43829769663e-11, -4.2106817679e-27],
[3, 4, 1.0, 3.43829769663e-11, 4.2106817679e-27],
[3, 4, 1.0, 3.43829769663e-11, 4.2106817679e-27],
[3, 4, 1.0, -9.60653778748e-12, 0.0],
[3, 4, 1.0, -9.60653778748e-12, 0.0],
[6, 8, -0.3368191474, -0.923253177958, 0.184814586371],
[7, 9, -0.0257610515846, -0.999035371738, 0.0355625397974],
[8, 9, -0.730619816405, -0.428084349835, 0.531919611692],
]
    candidate_parts = [6, 7, 8, 9]
    installed_parts = [0, 1, 2, 3, 4, 5]

    result = gkr_mult_drt_robot.solver.multiple_directions_calculator.\
        compute_simultaneous_translational_disassembling_directions_avoiding_nonneighbor_collision(test_graph, candidate_parts, installed_parts, points)

    print(result)

def test_case2():
    test_graph = [[1, 2, 0.519615242271, -0.3, -0.8],
                  [1, 2, 0.866025403784, -0.5, -6.12323399574e-17],
                  [1, 3, 0.519615242271, 0.3, -0.8],
                  [1, 3, 0.866025403784, 0.5, 6.12323399574e-17],
                  [2, 3, 0.0257610515846, 0.999035371738, -0.0355625397974],
                  ]

    candidate_parts = [2, 3]
    install_parts = [0, 1]
    target_directions = [[0, 0, 1], [0, 0, 1]]

    result = gkr_mult_drt_robot.solver.multiple_directions_calculator.compute_simultaneous_translational_disassembling_directions_without_guidance(test_graph, candidate_parts,
                                                                                                                                                   install_parts)
    print(result)

    result = gkr_mult_drt_robot.solver.multiple_directions_calculator.compute_simultaneous_translational_disassembling_directions_with_guidance(test_graph, candidate_parts,
                                                                                                                                                install_parts, target_directions)
    print(result)


if __name__ == '__main__':
    test_case1()



